<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LaluLintasKu ‚Äî Statistik & Laporan</title>
    <style>
        :root{
          --blue-dark:#0056b3;
          --blue:#004494;
          --page-bg:#fff;
          --panel-bg: rgba(209, 236, 241, 0.9);
          --sidebar-header-bg: #0056b3;
        }
        body{
          margin:0; font-family: Inter, system-ui, Arial, sans-serif;
          background-image: url('background.png');
          background-size: cover;
          background-attachment: fixed;
          background-position: center;
          background-color: var(--page-bg);
          overflow-x: hidden;
        }
        .header{
          background: var(--blue-dark);
          color:#fff;
          padding:12px 24px;
          position:fixed;
          top:0;
          width:100%;
          box-sizing:border-box;
          z-index: 1000;
          text-align:center;
        }
        .header h1{ margin:0; font-size:20px; display:inline-block; vertical-align:middle; }
        .header .menu-btn {
            display: none; /* Default disembunyikan untuk desktop */
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .sidebar {
            height: 100%;
            width: 60px; /* Ukuran default di desktop, hanya ikon */
            position: fixed;
            top: 0;
            left: 0;
            background: var(--panel-bg);
            transition: transform 0.3s ease, width 0.3s ease;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 2000;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }
        /* Sidebar di desktop (tidak ada hover, selalu 60px) */
        .sidebar-header {
            background: var(--sidebar-header-bg);
            color: #fff;
            padding: 12px 16px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 48px;
        }
        .sidebar-header .emoji {
            font-size: 24px;
            margin-right: 10px;
        }
        .sidebar-header .text {
            display: none; /* Teks disembunyikan di desktop */
        }
        .close-btn {
            display: none; /* Default disembunyikan, hanya muncul di mobile saat sidebar terbuka */
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .sidebar a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            font-size: 15px;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .sidebar a .emoji {
            font-size: 20px;
            margin-right: 20px;
            min-width: 20px;
            text-align: center;
        }
        .sidebar a .link-text {
            display: none; /* Teks disembunyikan di desktop */
        }
        .sidebar a:hover, .sidebar a.active{ background: rgba(0,0,0,0.1); }

        .main{
            padding: 80px 24px 24px;
            max-width:1000px;
            margin-left: 60px; /* Jarak untuk sidebar 60px di desktop */
            transition: margin-left 0.3s ease;
            margin-right: auto;
        }
        .card{ background:#fff; border-radius:16px; padding:24px; box-shadow:0 6px 18px rgba(0,0,0,0.08); margin:12px auto; text-align:center; }
        .card h2, .card h3{ margin-top:0; margin-bottom:12px; color:#111; }
        select, textarea, input[type="text"], input[type="file"]{
          width:92%; max-width:560px; padding:10px; border-radius:10px; border:1px solid #d0d0d0; font-size:15px; margin-bottom:10px;
        }
        textarea{ min-height:110px; resize:vertical; }
        .btn{ margin-top:16px; background:var(--blue-dark); color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:600; }
        .btn:hover{ background:var(--blue); }
        .stats-card{ max-width:900px; margin:18px auto; padding:18px; border-radius:12px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.06);}
        table{ width:100%; border-collapse:collapse; margin-top:12px;}
        th,td{ padding:8px 10px; border:1px solid #e6e6e6; text-align:center; font-size:14px;}
        th{ background:#f7faf7; color:#222; }
        .status-lancar{ color:#2b8a3e; font-weight:700; }
        .status-ramai{ color:#f08c00; font-weight:700; }
        .status-padat{ color:#c67a00; font-weight:700; }
        .status-macet{ color:#d92727; font-weight:700; }
        .status-gangguan{ color:#f0a500; font-weight:700; }
        .status-kecelakaan{ color:#ff0000; font-weight:700; }
        .muted{ color:#666; font-size:13px; margin-top:8px; }
        .small{ font-size:13px; color:#444; }
        .filter-item {
          margin-bottom: 12px;
          text-align: left;
        }
        .filter-item label {
          display: block;
          margin-bottom: 4px;
          font-weight: 600;
        }
        .filter-item select {
          width: 100%;
        }
        .status-lancar {
          color: #2b8a3e;
        }
        .status-macet {
          color: #d92727;
        }

        /* MEDIA QUERIES UNTUK TAMPILAN HP */
        @media (max-width: 640px) {
            .header .menu-btn {
                display: block; /* Tombol menu di header muncul di HP */
            }
            .sidebar {
                width: 0;
                transform: translateX(-100%); /* Sembunyikan sidebar di HP secara default */
                box-shadow: none;
            }
            .sidebar.open {
                width: 250px; /* Lebar sidebar saat dibuka di HP */
                transform: translateX(0);
                box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            }
            .sidebar-header .text, .sidebar a .link-text {
                display: inline; /* Teks di sidebar muncul saat dibuka di HP */
            }
            .close-btn {
                display: block; /* Tombol tutup muncul di HP saat sidebar terbuka */
            }
            .main {
                margin-left: 0; /* Konten utama mengambil seluruh lebar di HP */
            }
        }
    </style>
</head>
<body>

<header class="header">
  <button class="menu-btn" id="menuBtn">‚ò∞</button>
  <h1>üö¶ LaluLintasKu</h1>
</header>

<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <span class="emoji">‚ò∞</span><span class="text"> LaluLintasKu</span>
    <button class="close-btn" id="closeBtn">‚úñ</button>
  </div>
  <a href="#" data-target="statistikSection" class="active"><span class="emoji">üìä</span><span class="link-text">Statistik</span></a>
  <a href="#" data-target="laporanSection"><span class="emoji">üìã</span><span class="link-text">Laporan</span></a>
  <a href="#" data-target="amanSection"><span class="emoji">üöó</span><span class="link-text">Cara Mengemudi Aman</span></a>
  <a href="#" data-target="kameraSection"><span class="emoji">üì∏</span><span class="link-text">Statistik sistem kamera</span></a>
  <a href="#" data-target="loginSection"><span class="emoji">üîë</span><span class="link-text">Login</span></a>
</nav>

<main class="main">

<section id="statistikSection" class="stats-card">
  <h3>üìä Statistik Laporan (‚â§ 1 jam)</h3>
  <div style="margin-bottom:12px;">
    <div class="filter-item">
      <label for="filterProv">Provinsi:</label>
      <select id="filterProv">
        <option value="">-- Pilih Provinsi --</option>
        <option value="Jawa Timur">Jawa Timur</option>
        <option value="Jawa Barat">Jawa Barat</option>
        <option value="DKI Jakarta">DKI Jakarta</option>
      </select>
    </div>
    
    <div class="filter-item">
      <label for="filterKota">Kota:</label>
      <select id="filterKota">
        <option value="">-- Pilih Kota --</option>
      </select>
    </div>
    
    <div class="filter-item">
      <label for="filterDaerah">Daerah:</label>
      <select id="filterDaerah">
        <option value="">-- Pilih Daerah --</option>
      </select>
    </div>
  </div>

  <div id="chartContainer">
    <div id="chartBox"><canvas id="chart"></canvas></div>
    <div id="chartInfo">Belum ada laporan.</div>
  </div>
</section>

<section id="laporanSection" class="card" style="display:none;">
  <h2>Laporan Lalu Lintas</h2>
  <label for="provinsi">Pilih Provinsi:</label>
  <select id="provinsi"><option value="">-- Pilih Provinsi --</option><option value="Jawa Timur">Jawa Timur</option><option value="Jawa Barat">Jawa Barat</option><option value="DKI Jakarta">DKI Jakarta</option></select>

  <div id="kotaWrap" style="display:none;"><label for="kota">Pilih Kota/Kabupaten:</label><select id="kota"><option value="">-- Pilih Kota --</option></select></div>
  <div id="daerahWrap" style="display:none;"><label for="daerah">Pilih Daerah/Kecamatan:</label><select id="daerah"><option value="">-- Pilih Daerah --</option></select></div>
  <div id="jalanWrap" style="display:none;"><label for="jalan">Pilih Nama Jalan:</label><select id="jalan"><option value="">-- Pilih Nama Jalan --</option></select></div>
  <div id="statusWrap" style="display:none;"><label for="status">Status Kondisi:</label><select id="status"><option value="">-- Pilih Kondisi --</option><option value="Macet">Macet</option><option value="Gangguan Lalu Lintas">Gangguan Lalu Lintas</option><option value="Kecelakaan">Kecelakaan</option></select></div>
  <div id="descWrap" style="display:none;"><label for="deskripsi">Deskripsi (opsional):</label><textarea id="deskripsi" placeholder="Contoh: Lampu merah tidak berfungsi / antrean 500m"></textarea></div>
  <div id="fotoWrap" style="display:none;"><label for="foto">Tambahkan Foto (opsional):</label><input type="file" id="foto" accept="image/*"><img id="fotoPreview" src=""></div>
  <div id="lokasiWrap" style="display:none;"><button class="btn" id="getLocationBtn">üìç Dapatkan Lokasi</button><div id="lokasiInfo" class="small"></div></div>
  <div id="submitWrap" style="display:none;"><button class="btn" id="submitBtn">Kirim Laporan</button><div class="muted">Laporan akan masuk ke ringkasan dan statistik. Batas maksimal 1 laporan per 20 menit per device.</div></div>
  <div id="summary" style="margin-top:18px;"></div>
</section>

<section id="amanSection" class="card" style="display:none;">
  <h3>Cara Mengemudi Aman</h3>
  <ul style="text-align:left;">
    <li>Roda 2: Gunakan helm, patuhi rambu, jaga jarak.</li>
    <li>Roda 4: Pakai sabuk pengaman, jangan pakai HP saat mengemudi.</li>
    <li>Truck: Periksa muatan, patuhi batas kecepatan, gunakan lampu tambahan.</li>
  </ul>
</section>

<section id="kameraSection" class="card" style="display:none;">
  <h3>üì∏ Statistik sistem kamera</h3>
  <div id="statusKamera">
    <p style="font-size: 1.5rem; font-weight: bold; margin-bottom: 8px;">Status:</p>
    <span id="trafficStatus" class="status-lancar">...</span>
    <p class="muted">Jumlah Kendaraan: <span id="vehicleCount">...</span></p>
  </div>
</section>

<section id="loginSection" class="card" style="display:none;">
  <h3>Login (Sementara)</h3>
  <p class="small">Demo akun tunggal.</p>
</section>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAVHQKQ3iAGWPepnd_DuoGQmpxG40i8uMs",
      authDomain: "laporan-lalu-lintas.firebaseapp.com",
      databaseURL: "https://laporan-lalu-lintas-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "laporan-lalu-lintas",
      storageBucket: "laporan-lalu-lintas.appspot.com",
      messagingSenderId: "706382913725",
      appId: "1:706382913725:web:1069a4f53bea6b66a357d4"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.getElementById('menuBtn');
    const closeBtn = document.getElementById('closeBtn');

    menuBtn.addEventListener('click', () => {
        sidebar.classList.add('open');
    });

    closeBtn.addEventListener('click', () => {
        sidebar.classList.remove('open');
    });

    sidebar.querySelectorAll('a[data-target]').forEach(a=>{
      a.addEventListener('click', e=>{
        e.preventDefault();
        const target = a.dataset.target;
        document.querySelectorAll('main section').forEach(s=>s.style.display='none');
        document.getElementById(target).style.display='block';
        sidebar.querySelectorAll('a').forEach(link=>link.classList.remove('active'));
        a.classList.add('active');
        if (window.innerWidth <= 640) {
            sidebar.classList.remove('open');
        }
      });
    });

    const provEl = document.getElementById('provinsi');
    const kotaEl = document.getElementById('kota');
    const daerahEl = document.getElementById('daerah');
    const jalanEl = document.getElementById('jalan');
    const kotaWrap = document.getElementById('kotaWrap');
    const daerahWrap = document.getElementById('daerahWrap');
    const jalanWrap = document.getElementById('jalanWrap');
    const statusWrap = document.getElementById('statusWrap');
    const descEl = document.getElementById('deskripsi');
    const submitWrap = document.getElementById('submitWrap');
    const fotoWrap = document.getElementById('fotoWrap');
    const lokasiWrap = document.getElementById('lokasiWrap');
    const summaryDiv = document.getElementById('summary');
    const lokasiInfo = document.getElementById('lokasiInfo');
    const fotoEl = document.getElementById('foto');
    const fotoPreview = document.getElementById('fotoPreview');

    const wilayah = {
      "Jawa Timur": {
        "Surabaya": {
          "Genteng": ["Jalan Tunjungan", "Jalan Gubernur Suryo", "Jalan Embong Malang"],
          "Wonokromo": ["Jalan Joyoboyo", "Jalan Ngagel", "Jalan Raya Darmo"]
        },
        "Sidoarjo": {
          "Krian": ["Jalan Raya Krian", "Jalan Ahmad Yani", "Jalan Basuki Rahmat"],
          "Waru": ["Jalan Raya Waru", "Jalan Letjend Suprapto", "Jalan Bypass Juanda"]
        },
        "Banyuwangi": {
          "Kecamatan Glagah": ["Jalan Raya Glagah", "Jalan Raya Licin", "Jalan Raya Rogojampi"],
          "Kecamatan Rogojampi": ["Jalan Raya Rogojampi", "Jalan S Parman", "Jalan MH Thamrin"]
        }
      },
      "Jawa Barat": {
        "Bandung": {
          "Coblong": ["Jalan Dago", "Jalan Ciumbuleuit", "Jalan Dipati Ukur"],
          "Sukajadi": ["Jalan Sukajadi", "Jalan Setiabudi", "Jalan Dr. Setiabudhi"]
        },
        "Bekasi": {
          "Bekasi Timur": ["Jalan Pahlawan", "Jalan Cut Mutia", "Jalan Ir. H. Juanda"],
          "Bekasi Selatan": ["Jalan Ahmad Yani", "Jalan KH Noer Ali", "Jalan Jend Sudirman"]
        }
      },
      "DKI Jakarta": {
        "Jakarta Pusat": {
          "Gambir": ["Jalan Medan Merdeka", "Jalan Majapahit", "Jalan Veteran"],
          "Menteng": ["Jalan Menteng Raya", "Jalan Teuku Umar", "Jalan Cikini Raya"]
        },
        "Jakarta Timur": {
          "Duren Sawit": ["Jalan Pahlawan Revolusi", "Jalan Swadaya", "Jalan Dermaga"],
          "Cakung": ["Jalan Raya Cakung", "Jalan Raya Bekasi", "Jalan I Gusti Ngurah Rai"]
        }
      }
    };

    provEl.addEventListener('change', ()=>{
      const prov = provEl.value;
      kotaEl.innerHTML='<option value="">-- Pilih Kota --</option>';
      daerahEl.innerHTML='<option value="">-- Pilih Daerah --</option>';
      jalanEl.innerHTML='<option value="">-- Pilih Nama Jalan --</option>';
      kotaWrap.style.display=daerahWrap.style.display=jalanWrap.style.display=statusWrap.style.display='none';
      descEl.parentNode.style.display='none';
      submitWrap.style.display=fotoWrap.style.display=lokasiWrap.style.display='none';
      summaryDiv.innerHTML='';
      if(prov && wilayah[prov]){
        Object.keys(wilayah[prov]).forEach(k=>{
          const o=document.createElement('option'); o.value=k; o.textContent=k; kotaEl.appendChild(o);
        });
        kotaWrap.style.display='block';
      }
    });

    kotaEl.addEventListener('change', ()=>{
      const prov=provEl.value, kota=kotaEl.value;
      daerahEl.innerHTML='<option value="">-- Pilih Daerah --</option>';
      jalanEl.innerHTML='<option value="">-- Pilih Nama Jalan --</option>';
      daerahWrap.style.display=jalanWrap.style.display=statusWrap.style.display='none';
      descEl.parentNode.style.display='none';
      submitWrap.style.display=fotoWrap.style.display=lokasiWrap.style.display='none';
      summaryDiv.innerHTML='';
      if(prov && kota && wilayah[prov][kota]){
        Object.keys(wilayah[prov][kota]).forEach(d=>{
          const o=document.createElement('option'); o.value=d; o.textContent=d; daerahEl.appendChild(o);
        });
        daerahWrap.style.display='block';
      }
    });

    daerahEl.addEventListener('change', ()=>{
      const prov=provEl.value, kota=kotaEl.value, daerah=daerahEl.value;
      jalanEl.innerHTML='<option value="">-- Pilih Nama Jalan --</option>';
      if(daerah && wilayah[prov][kota][daerah]){
        wilayah[prov][kota][daerah].forEach(j=>{
          const o=document.createElement('option'); o.value=j; o.textContent=j; jalanEl.appendChild(o);
        });
        jalanWrap.style.display='block';
        statusWrap.style.display='block';
        descEl.parentNode.style.display='block';
        submitWrap.style.display=fotoWrap.style.display=lokasiWrap.style.display='block';
        updateSummary();
      } else {
        jalanWrap.style.display='none';
        statusWrap.style.display='none';
        descEl.parentNode.style.display='none';
        submitWrap.style.display=fotoWrap.style.display=lokasiWrap.style.display='none';
        summaryDiv.innerHTML='';
      }
    });

    let currentLocation = null;
    document.getElementById('getLocationBtn').addEventListener('click', ()=>{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          currentLocation = {lat: pos.coords.latitude, lng: pos.coords.longitude};
          lokasiInfo.textContent = `Latitude: ${currentLocation.lat.toFixed(5)}, Longitude: ${currentLocation.lng.toFixed(5)}`;
        }, ()=>{ lokasiInfo.textContent='Gagal mendapatkan lokasi'; });
      }else{ lokasiInfo.textContent='Browser tidak mendukung GPS'; }
    });

    fotoEl.addEventListener('change', ()=>{
      if(fotoEl.files[0]){
        const reader = new FileReader();
        reader.onload = e=>{ fotoPreview.src = e.target.result; };
        reader.readAsDataURL(fotoEl.files[0]);
      } else { fotoPreview.src = ''; }
    });

    let lastSent = localStorage.getItem('lastSent') || 0;
    const canSend = ()=> Date.now() - lastSent >= 20*60*1000;

    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    submitBtn.addEventListener('click', async () => {
      if (!provEl.value || !kotaEl.value || !daerahEl.value || !jalanEl.value || !statusEl.value) {
        alert('Mohon lengkapi semua pilihan yang tersedia.');
        return;
      }
      if (!canSend()) {
        alert('‚è± Tunggu 20 menit sebelum mengirim laporan lagi.');
        return;
      }

      const laporan = {
        provinsi: provEl.value,
        kota: kotaEl.value,
        daerah: daerahEl.value,
        jalan: jalanEl.value || '',
        status: statusEl.value,
        deskripsi: descEl.value || '',
        foto: '',
        lokasi: currentLocation || {},
        waktu: Date.now()
      };

      if (fotoEl.files.length > 0) {
        try {
          const file = fotoEl.files[0];
          const storageRef = sRef(storage, `laporan_foto/${Date.now()}_${file.name}`);
          const uploadTask = uploadBytesResumable(storageRef, file);

          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Unggah foto sedang berjalan: ' + progress.toFixed(0) + '%');
              },
              (error) => {
                reject(error);
              },
              () => {
                resolve();
              }
            );
          });
          
          laporan.foto = await getDownloadURL(storageRef);
          console.log("Foto berhasil diunggah. URL:", laporan.foto);
        } catch (e) {
          console.error("Kesalahan saat mengunggah foto:", e);
          alert('‚ö†Ô∏è Gagal mengunggah foto. Laporan tetap akan dikirim tanpa foto.');
        }
      }

      try {
        await push(ref(db, 'laporan'), laporan);
        console.log("Laporan berhasil dikirim!");

        lastSent = Date.now();
        localStorage.setItem('lastSent', lastSent);
        statusEl.value = '';
        descEl.value = '';
        fotoEl.value = '';
        fotoPreview.src = '';
        currentLocation = null;
        lokasiInfo.textContent = '';
        alert('‚úÖ Laporan berhasil dikirim!');
      } catch (error) {
        console.error("Kesalahan saat mengirim laporan ke Realtime Database:", error);
        alert('‚ùå Gagal mengirim laporan. Coba lagi atau periksa koneksi internet Anda.');
      }
    });

    const ctx = document.getElementById('chart').getContext('2d');
    let chart = new Chart(ctx, {type:'bar', data:{labels:['Macet','Gangguan Lalu Lintas','Kecelakaan'], datasets:[{label:'Jumlah Laporan',data:[0,0,0],backgroundColor:['#d92727','#f0a500','#ff0000']}]}, options:{responsive:true,plugins:{legend:{display:false}}}});

    const filterProv = document.getElementById('filterProv');
    const filterKota = document.getElementById('filterKota');
    const filterDaerah = document.getElementById('filterDaerah');

    filterProv.addEventListener('change', ()=>{
      filterKota.innerHTML='<option value="">-- Pilih Kota --</option>';
      filterDaerah.innerHTML='<option value="">-- Pilih Daerah --</option>';
      if(filterProv.value && wilayah[filterProv.value]){
        Object.keys(wilayah[filterProv.value]).forEach(k=>{
          const o=document.createElement('option'); o.value=k; o.textContent=k; filterKota.appendChild(o);
        });
      }
      updateChart();
    });
    filterKota.addEventListener('change', ()=>{
      filterDaerah.innerHTML='<option value="">-- Pilih Daerah --</option>';
      if(filterProv.value && filterKota.value && wilayah[filterProv.value][filterKota.value]){
        Object.keys(wilayah[filterProv.value][filterKota.value]).forEach(d=>{
          const o=document.createElement('option'); o.value=d; o.textContent=d; filterDaerah.appendChild(o);
        });
      }
      updateChart();
    });
    filterDaerah.addEventListener('change', updateChart);

    function updateChart(){
      if(!filterProv.value || !filterKota.value || !filterDaerah.value) { document.getElementById('chartInfo').innerText='Pilih Provinsi, Kota, dan Daerah terlebih dahulu'; return; }

      onValue(ref(db,'laporan'), snapshot=>{
        const data = snapshot.val() || {};
        const now = Date.now();
        const laporanArr = Object.values(data).filter(l=> now - l.waktu < 3600000 );
        const counts={'Macet':0,'Gangguan Lalu Lintas':0,'Kecelakaan':0};
        laporanArr.forEach(l=>{
          if(l.provinsi!==filterProv.value || l.kota!==filterKota.value || l.daerah!==filterDaerah.value) return;
          if(counts[l.status]!==undefined) counts[l.status]++;
        });
        chart.data.datasets[0].data = [counts['Macet'], counts['Gangguan Lalu Lintas'], counts['Kecelakaan']];
        chart.update();
        const total=Object.values(counts).reduce((a,b)=>a+b,0);
        let mayoritas='Belum ada laporan';
        let alasan='';
        if(total>0){
          const max=Math.max(...Object.values(counts));
          const winners=Object.keys(counts).filter(k=>counts[k]===max && max>0);
          mayoritas=winners.length===1?winners[0]:'Seimbang';
          alasan=`Jumlah laporan terbanyak di kategori "${mayoritas}"`;
        }
        document.getElementById('chartInfo').innerHTML=`
          <b>Total laporan:</b> ${total}<br>
          <b>Macet:</b> ${counts['Macet']}<br>
          <b>Gangguan Lalu Lintas:</b> ${counts['Gangguan Lalu Lintas']}<br>
          <b>Kecelakaan:</b> ${counts['Kecelakaan']}<br>
          <b>Mayoritas:</b> ${mayoritas}<br>
          <b>Alasan:</b> ${alasan}
        `;
      });
    }
    updateChart();

    function updateSummary(){
      const prov=provEl.value, kota=kotaEl.value, daerah=daerahEl.value;
      if(!prov||!kota||!daerah) return;
      onValue(ref(db,'laporan'), snapshot=>{
        const data = snapshot.val() || {};
        const now = Date.now();
        const laporanArr = Object.values(data).filter(l=> now - l.waktu < 3600000 );
        const counts={'Macet':0,'Gangguan Lalu Lintas':0,'Kecelakaan':0};
        laporanArr.forEach(l=>{ if(l.provinsi===prov && l.kota===kota && l.daerah===daerah) counts[l.status]++; });
        const total=Object.values(counts).reduce((a,b)=>a+b,0);
        let mayoritas='Belum ada laporan', alasan='';
        if(total>0){
          const max=Math.max(...Object.values(counts));
          const winners=Object.keys(counts).filter(k=>counts[k]===max && max>0);
          mayoritas=winners.length===1?winners[0]:'Seimbang';
          alasan=`Jumlah laporan terbanyak di kategori "${mayoritas}"`;
        }
        summaryDiv.innerHTML=`<div style="margin-top:16px; text-align:center;">
          <div style="display:inline-block; padding:10px 16px; background:#f7f7f7; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.04);">
            <div style="font-size:14px;color:#555">Ringkasan untuk <b>${daerah}, ${kota}</b></div>
            <div style="margin-top:8px; text-align:left;">
              <div>Macet: <b>${counts['Macet']}</b></div>
              <div>Gangguan Lalu Lintas: <b>${counts['Gangguan Lalu Lintas']}</b></div>
              <div>Kecelakaan: <b>${counts['Kecelakaan']}</b></div>
              <div style="margin-top:8px;color:#222">Mayoritas: <b>${mayoritas}</b></div>
              <div style="color:#444">Alasan: ${alasan}</div>
            </div>
          </div>
        </div>`;
      });
    }

    const trafficStatusEl = document.getElementById('trafficStatus');
    const vehicleCountEl = document.getElementById('vehicleCount');
    const kameraRef = ref(db, 'traffic/status');

    onValue(kameraRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            trafficStatusEl.textContent = data.status.toUpperCase();
            vehicleCountEl.textContent = data.vehicle_count;
            trafficStatusEl.classList.remove('status-lancar', 'status-macet');
            if (data.status === 'macet') {
                trafficStatusEl.classList.add('status-macet');
            } else {
                trafficStatusEl.classList.add('status-lancar');
            }
        } else {
            trafficStatusEl.textContent = "DATA TIDAK TERSEDIA";
            vehicleCountEl.textContent = "-";
            trafficStatusEl.classList.remove('status-macet');
            trafficStatusEl.classList.add('status-lancar');
        }
    });
</script>
</body>
</html>
