<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LaluLintasKu â€” Laporan</title>
<style>
:root{
  --green:#007a1c;
  --green-dark:#005c15;
  --page-bg:#fff;
  --panel-bg: rgba(0,0,0,0.7);
}
body{
  margin:0; font-family: Inter, system-ui, Arial, sans-serif; background: var(--page-bg);
}
.header{
  background: var(--green); color:#fff; padding:12px 16px; position:relative; text-align:center;
}
.header .menu-btn{
  position:absolute; left:12px; top:8px; font-size:22px; cursor:pointer;
  transition: transform .25s;
}
.header .menu-btn.rotate{ transform: rotate(90deg); }
.header h1{ margin:0; font-size:20px; display:inline-block; vertical-align:middle; }
.sidebar{
  position:fixed; top:0; left:-250px; width:250px; height:100%; background:var(--panel-bg); padding-top:60px;
  transition:left .25s ease; z-index:2000;
}
.sidebar.active{ left:0; }
.sidebar a{
  display:block; padding:12px 20px; color:#fff; text-decoration:none; font-size:15px;
  transition: background .2s;
}
.sidebar a:hover{ background: rgba(255,255,255,0.08); }
.main{ padding:24px; max-width:1000px; margin:24px auto; }
.card{
  background:#fff; border-radius:16px; padding:24px; box-shadow:0 6px 18px rgba(0,0,0,0.08); margin:12px auto; text-align:center;
}
.card h2{ margin-top:0; margin-bottom:12px; color:#111; }
select, textarea, input[type="text"]{ width:92%; max-width:560px; padding:10px; border-radius:10px; border:1px solid #d0d0d0; font-size:15px; margin-bottom:10px; }
textarea{ min-height:110px; resize:vertical; }
.btn{ margin-top:16px; background:var(--green); color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:600; }
.btn:hover{ background:var(--green-dark); }
.stats-card{ max-width:900px; margin:18px auto; padding:18px; border-radius:12px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.06);}
table{ width:100%; border-collapse:collapse; margin-top:12px;}
th,td{ padding:8px 10px; border:1px solid #e6e6e6; text-align:center; font-size:14px;}
th{ background:#f7faf7; color:#222; }
.status-lancar{ color:#2b8a3e; font-weight:700; }
.status-ramai{ color:#f08c00; font-weight:700; }
.status-padat{ color:#c67a00; font-weight:700; }
.status-macet{ color:#d92727; font-weight:700; }
.muted{ color:#666; font-size:13px; margin-top:8px; }
.small{ font-size:13px; color:#444; }
@media(max-width:640px){ .card{ width:94%; padding:18px; } select,input,textarea{ width:100%; } .sidebar{ width:220px; } }
#logoSmall{ display:block; margin:20px auto; max-width:300px; height:auto; }
</style>
</head>
<body>

<header class="header">
  <span class="menu-btn" id="menuBtn">â˜°</span>
  <h1>
  ðŸš¦ LaluLintasKu
</h1>
</header>
<img src="logo.png" alt="Logo" id="logoSmall">

<nav class="sidebar" id="sidebar">
  <a href="#" data-target="laporanSection">ðŸ“‹ Laporan</a>
  <a href="#" data-target="statistikSection">ðŸ“Š Statistik</a>
  <a href="#" data-target="amanSection">ðŸš— Cara Mengemudi Aman</a>
  <a href="#" data-target="loginSection">ðŸ”‘ Login</a>
</nav>

<main class="main">
  <section id="laporanSection" class="card">
    <h2>Laporan Lalu Lintas</h2>
    <label for="provinsi">Pilih Provinsi:</label>
    <select id="provinsi"><option value="">-- Pilih Provinsi --</option><option value="Jawa Timur">Jawa Timur</option><option value="Jawa Barat">Jawa Barat</option><option value="DKI Jakarta">DKI Jakarta</option></select>
    <div id="kotaWrap" style="display:none;"><label for="kota">Pilih Kota/Kabupaten:</label><select id="kota"><option value="">-- Pilih Kota --</option></select></div>
    <div id="daerahWrap" style="display:none;"><label for="daerah">Pilih Daerah/Kecamatan:</label><select id="daerah"><option value="">-- Pilih Daerah --</option></select></div>
    <div id="statusWrap" style="display:none;"><label for="status">Status Kondisi:</label><select id="status"><option value="">-- Pilih Kondisi --</option><option value="Lancar">Lancar</option><option value="Ramai">Ramai</option><option value="Padat">Padat</option><option value="Macet">Macet</option></select></div>
    <div id="descWrap" style="display:none;"><label for="deskripsi">Deskripsi (opsional):</label><textarea id="deskripsi" placeholder="Contoh: Lampu merah tidak berfungsi / antrean 500m (boleh dikosongkan)"></textarea></div>
    <div id="submitWrap" style="display:none;"><button class="btn" id="submitBtn">Kirim Laporan</button><div class="muted">Laporan akan masuk ke ringkasan dan statistik.</div></div>
    <div id="summary" style="margin-top:18px;"></div>
  </section>

  <section id="statistikSection" class="stats-card" style="display:none;">
    <h3>ðŸ“Š Statistik Laporan (â‰¤ 1 jam)</h3>
    <div id="statsSummary" class="small">Belum ada laporan.</div>
    <table id="statsTable" style="display:none;">
      <thead><tr><th>Daerah (Kota)</th><th>Lancar</th><th>Ramai</th><th>Padat</th><th>Macet</th><th>Total</th><th>Mayoritas</th></tr></thead>
      <tbody id="statsTbody"></tbody>
    </table>
    <h4>Laporan Terbaru</h4>
    <div id="recentList" class="small" style="text-align:left;"></div>
  </section>

  <section id="amanSection" class="card" style="display:none;">
    <h3>Cara Mengemudi dengan Aman</h3>
    <ul style="text-align:left;">
      <li>Gunakan helm/sabuk pengaman.</li>
      <li>Patuhi rambu lalu lintas.</li>
      <li>Jaga jarak aman antar kendaraan.</li>
      <li>Hindari HP saat berkendara.</li>
      <li>Istirahat jika lelah.</li>
    </ul>
  </section>

  <section id="loginSection" class="card" style="display:none;">
    <h3>Login (Sementara)</h3>
    <p class="small">Demo akun tunggal.</p>
  </section>
</main>

<script type="module">
// Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVHQKQ3iAGWPepnd_DuoGQmpxG40i8uMs",
  authDomain: "laporan-lalu-lintas.firebaseapp.com",
  databaseURL: "https://laporan-lalu-lintas-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laporan-lalu-lintas",
  storageBucket: "laporan-lalu-lintas.appspot.com",
  messagingSenderId: "706382913725",
  appId: "1:706382913725:web:1069a4f53bea6b66a357d4"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Sidebar toggle + animasi
const menuBtn = document.getElementById('menuBtn');
const sidebar = document.getElementById('sidebar');
menuBtn.addEventListener('click', ()=>{
  sidebar.classList.toggle('active');
  menuBtn.classList.toggle('rotate');
});

// Sidebar nav
sidebar.querySelectorAll('a[data-target]').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    const target = a.dataset.target;
    document.querySelectorAll('main section').forEach(s=>s.style.display='none');
    document.getElementById(target).style.display='block';
    sidebar.classList.remove('active'); menuBtn.classList.remove('rotate');
  });
});

// Wilayah
const provEl = document.getElementById('provinsi');
const kotaEl = document.getElementById('kota');
const daerahEl = document.getElementById('daerah');
const kotaWrap = document.getElementById('kotaWrap');
const daerahWrap = document.getElementById('daerahWrap');
const statusWrap = document.getElementById('statusWrap');
const descWrap = document.getElementById('descWrap');
const submitWrap = document.getElementById('submitWrap');
const summaryDiv = document.getElementById('summary');

const wilayah = {
  "Jawa Timur": { "Surabaya":["Genteng","Wonokromo"], "Sidoarjo":["Krian","Waru"], "Banyuwangi":["Kecamatan Glagah","Kecamatan Rogojampi"] },
  "Jawa Barat": { "Bandung":["Coblong","Sukajadi"], "Bekasi":["Bekasi Timur","Bekasi Selatan"] },
  "DKI Jakarta": { "Jakarta Pusat":["Gambir","Menteng"], "Jakarta Timur":["Duren Sawit","Cakung"] }
};

provEl.addEventListener('change', ()=>{
  const prov = provEl.value;
  kotaEl.innerHTML='<option value="">-- Pilih Kota --</option>';
  daerahEl.innerHTML='<option value="">-- Pilih Daerah --</option>';
  kotaWrap.style.display=daerahWrap.style.display=statusWrap.style.display=descWrap.style.display=submitWrap.style.display='none';
  summaryDiv.innerHTML='';
  if(prov && wilayah[prov]){
    Object.keys(wilayah[prov]).forEach(k=>{
      const o=document.createElement('option'); o.value=k; o.textContent=k; kotaEl.appendChild(o);
    });
    kotaWrap.style.display='block';
  }
});

kotaEl.addEventListener('change', ()=>{
  const prov=provEl.value, kota=kotaEl.value;
  daerahEl.innerHTML='<option value="">-- Pilih Daerah --</option>';
  daerahWrap.style.display=statusWrap.style.display=descWrap.style.display=submitWrap.style.display='none';
  summaryDiv.innerHTML='';
  if(prov && kota && wilayah[prov][kota]){
    wilayah[prov][kota].forEach(d=>{
      const o=document.createElement('option'); o.value=d; o.textContent=d; daerahEl.appendChild(o);
    });
    daerahWrap.style.display='block';
  }
});

daerahEl.addEventListener('change', ()=>{
  const d=daerahEl.value;
  if(d){ statusWrap.style.display=descWrap.style.display=submitWrap.style.display='block'; updateSummary(); }
  else{ statusWrap.style.display=descWrap.style.display=submitWrap.style.display='none'; summaryDiv.innerHTML=''; }
});

// Submit laporan
const statusEl = document.getElementById('status');
const descEl = document.getElementById('deskripsi');
const submitBtn = document.getElementById('submitBtn');
submitBtn.addEventListener('click', ()=>{
  if(!provEl.value || !kotaEl.value || !daerahEl.value || !statusEl.value){ alert('Lengkapi semua pilihan'); return; }
  const laporan={
    provinsi:provEl.value,
    kota:kotaEl.value,
    daerah:daerahEl.value,
    status:statusEl.value,
    deskripsi:descEl.value||'',
    waktu: Date.now() // timestamp
  };
  push(ref(db,'laporan'), laporan);
  statusEl.value=''; descEl.value='';
  alert('âœ… Laporan berhasil dikirim!');
});

// Statistik (â‰¤ 1 jam)
const statsSummary=document.getElementById('statsSummary');
const statsTable=document.getElementById('statsTable');
const statsTbody=document.getElementById('statsTbody');
const recentList=document.getElementById('recentList');

onValue(ref(db,'laporan'), snapshot=>{
  const data = snapshot.val() || {};
  const now = Date.now();
  const laporanArr = Object.values(data).filter(l=> now - l.waktu < 3600000 ).sort((a,b)=>b.waktu - a.waktu);

  const grouping={};
  laporanArr.forEach(l=>{
    const key=`${l.daerah}, ${l.kota}`;
    if(!grouping[key]) grouping[key]={Lancar:0,Ramai:0,Padat:0,Macet:0};
    if(grouping[key][l.status]!==undefined) grouping[key][l.status]++;
  });

  statsTbody.innerHTML='';
  Object.keys(grouping).forEach(key=>{
    const r=grouping[key];
    const total=r.Lancar+r.Ramai+r.Padat+r.Macet;
    const maxCount=Math.max(r.Lancar,r.Ramai,r.Padat,r.Macet);
    const winners=['Lancar','Ramai','Padat','Macet'].filter(k=>r[k]===maxCount && maxCount>0);
    const mayoritas=winners.length===1?winners[0]:'Seimbang';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${key}</td><td class="status-lancar">${r.Lancar}</td><td class="status-ramai">${r.Ramai}</td><td class="status-padat">${r.Padat}</td><td class="status-macet">${r.Macet}</td><td>${total}</td><td><b>${mayoritas}</b></td>`;
    statsTbody.appendChild(tr);
  });

  statsSummary.innerHTML=`Total laporan: <b>${laporanArr.length}</b> â€¢ Daerah terlapor: <b>${Object.keys(grouping).length}</b>`;
  statsTable.style.display=laporanArr.length>0?'table':'none';
  recentList.innerHTML='';
  laporanArr.slice(0,10).forEach(r=>{
    const d=document.createElement('div');
    d.style.padding='6px 0';
    const waktuStr=new Date(r.waktu).toLocaleTimeString();
    d.innerHTML=`<b>[${waktuStr}]</b> ${r.daerah}, ${r.kota} â€” <span class="small">${r.status}</span>${r.deskripsi?'- '+r.deskripsi:''}`;
    recentList.appendChild(d);
  });
});

// Ringkasan per daerah
function updateSummary(){
  const prov=provEl.value, kota=kotaEl.value, daerah=daerahEl.value;
  if(!prov||!kota||!daerah) return;
  onValue(ref(db,'laporan'), snapshot=>{
    const data = snapshot.val() || {};
    const now = Date.now();
    const laporanArr = Object.values(data).filter(l=> now - l.waktu < 3600000 );
    const counts={Lancar:0,Ramai:0,Padat:0,Macet:0};
    laporanArr.forEach(l=>{ if(l.provinsi===prov && l.kota===kota && l.daerah===daerah) counts[l.status]++; });
    const total=counts.Lancar+counts.Ramai+counts.Padat+counts.Macet;
    let mayoritas='Belum ada laporan';
    if(total>0){ const max=Math.max(...Object.values(counts)); const winners=Object.keys(counts).filter(k=>counts[k]===max && max>0); mayoritas=winners.length===1?winners[0]:'Seimbang'; }
    summaryDiv.innerHTML=`
    <div style="margin-top:16px; text-align:center;">
      <div style="display:inline-block; padding:10px 16px; background:#f7f7f7; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.04);">
        <div style="font-size:14px;color:#555">Ringkasan untuk <b>${daerah}, ${kota}</b></div>
        <div style="margin-top:8px; text-align:left;">
          <div>Lancar: <b>${counts.Lancar}</b></div>
          <div>Ramai: <b>${counts.Ramai}</b></div>
          <div>Padat: <b>${counts.Padat}</b></div>
          <div>Macet: <b>${counts.Macet}</b></div>
          <div style="margin-top:8px;color:#222">Mayoritas: <b>${mayoritas}</b></div>
        </div>
      </div>
    </div>`;
  });
}
</script>
</body>
</html>
